<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5>Tournament Matches</h5>
    <ng-template #popTemplate>
      <ul class="list-group p-1 shadow border">
        <li class="list-group-item" role="button" (click)="contentMenu.hide();openCreateModal(createMatchModal)">
          <i class="bi bi-plus me-2"></i> Create Match</li>
      </ul>
    </ng-template>
    <button type="button" class="btn btn-outline-dark border-0 btn-sm position-absolute top-0 end-0 m-1"
      #contentMenu="bs-popover" [popover]="popTemplate" container="body" placement="bottom" [outsideClick]="true">
      <i class="bi bi-three-dots-vertical"></i>
    </button>
  </div>

  <div class="card-body" style="max-height: calc(100dvh - 200px);overflow: auto;min-height: calc(100dvh - 200px);">
    <div *ngIf="loading" class="loading">Loading matches...</div>
  
    <div *ngIf="!loading && matches.length === 0" class="no-matches">
      No matches found. Create your first match!
    </div>
  
    <div *ngIf="!loading && matches.length > 0" class="row">
      <div *ngFor="let match of matches" class="col-md-6 col-lg-4 col-xl-3">
        <div class="mb-2 shadow-sm p-2 border">
          <div class="match-header position-relative">
            <h6>Round {{ match.round }} - Position {{ match.position }}</h6>
    
            <ng-template #popTemplate>
              <ul class="list-group p-1  shadow border">
                <li class="list-group-item" role="button" (click)="contentMenu.hide();openManageTeamsModal(match);"><i class="bi bi-gear me-2"></i>Manage Teams</li>
                <li class="list-group-item" role="button" (click)="contentMenu.hide();openEditModal(match, editMatchModal);"><i class="bi bi-pencil-fill me-2"></i> Edit Match</li>
                <li class="list-group-item" role="button" (click)="contentMenu.hide();deleteMatch(match.id);"><i class="bi bi-trash me-2"></i> Delete Match</li>
                <ng-container *ngIf="match.status !== 'completed' && match.team1 && match.team2" class="set-winner">
                  <li class="list-group-item" role="button" (click)="contentMenu.hide();setWinner(match, match.team1!.id!);"><i class="bi bi-trophy-fill me-2"></i> {{ match.team1.name }} Wins</li>
                  <li class="list-group-item" role="button" (click)="contentMenu.hide();setWinner(match, match.team2!.id!);"><i class="bi bi-trophy-fill me-2"></i> {{ match.team2.name }} Wins</li>
                </ng-container>
              </ul>
            </ng-template>
            <button type="button" class="btn btn-outline-dark border-0 btn-sm position-absolute top-0 end-0"
              #contentMenu="bs-popover" [popover]="popTemplate" container="body" placement="bottom"
              [outsideClick]="true">
              <i class="bi bi-three-dots-vertical"></i>
            </button>
          </div>
          
          <div class="d-flex justify-content-between align-items-center">
            <div class="bg-warning col text-center m-2 rounded fs-6 py-1">
              @if(match.team1?.name){
                <i class="bi bi-people-fill"></i>
                {{match.team1?.name}}
              }@else {
                <i class="bi bi-question-lg"></i>
              }
            </div>
            <div class="fw-bold fs-6 text-danger" style="rotate: -20deg;"><i class="bi bi-amd"></i></div>
            <div class="bg-warning col text-center m-2 rounded fs-6 py-1">
              @if(match.team2?.name){
                <i class="bi bi-people-fill"></i>
                {{match.team2?.name}}
              }@else {
                <i class="bi bi-question-lg"></i>
              }
            </div>
          </div>
          
          <div class="match-info d-flex align-items-center w-100 mt-2">
            <div class="badge text-bg-danger fw-normal fs-6 me-auto">{{ match.status | titlecase}}</div>
            <div *ngIf="match.scheduledDate" class="badge text-bg-secondary fw-normal fs-6" [class.ms-auto]="!match.winner" [class.mx-auto]="match.winner">
              <i class="bi bi-calendar3 me-1"></i> {{ getFormattedDate(match.scheduledDate) }}
            </div>          
            <ng-container *ngIf="match.status === 'completed'">
              <div *ngIf="match.winner" class="badge text-bg-success fw-normal fs-6" [class.ms-auto]="match.winner">
                <i class="bi bi-trophy-fill me-1"></i> {{ match.winner.name }}
              </div>
            </ng-container>
  
          </div>
          
        </div>
      </div>
    </div>
  </div>


</div>

<!-- Create Match Modal -->
<ng-template #createMatchModal>
  <div class="modal-header">
    <h4 class="modal-title">Create New Match</h4>
    <button type="button" class="btn-close" (click)="createModalRef?.hide()"></button>
  </div>
  <div class="modal-body">
    <form (ngSubmit)="createMatch()">
      <div class="mb-3">
        <label class="form-label">Round:</label>
        <input type="number" [(ngModel)]="matchForm.round" name="round" min="1" required class="form-control">
      </div>
      <div class="mb-3">
        <label class="form-label">Position:</label>
        <input type="number" [(ngModel)]="matchForm.position" name="position" min="1" required class="form-control">
      </div>
      <div class="mb-3">
        <label class="form-label">Scheduled Date (Optional):</label>
        <input type="date" [(ngModel)]="matchForm.scheduledDate" name="scheduledDate" class="form-control">
      </div>
      <div class="d-flex justify-content-end gap-2">
        <button type="button" class="btn btn-secondary" (click)="createModalRef?.hide()">Cancel</button>
        <button type="submit" class="btn btn-primary">Create</button>
      </div>
    </form>
  </div>
</ng-template>

<!-- Edit Match Modal -->
<ng-template #editMatchModal>
  <div class="modal-header">
    <h4 class="modal-title">Edit Match</h4>
    <button type="button" class="btn-close" (click)="editModalRef?.hide()"></button>
  </div>
  <div class="modal-body">
    <form (ngSubmit)="updateMatch()">
      <div class="mb-3">
        <label class="form-label">Round:</label>
        <input type="number" [(ngModel)]="matchForm.round" name="round" min="1" required class="form-control">
      </div>
      <div class="mb-3">
        <label class="form-label">Position:</label>
        <input type="number" [(ngModel)]="matchForm.position" name="position" min="1" required class="form-control">
      </div>
      <div class="mb-3">
        <label class="form-label">Scheduled Date (Optional):</label>
        <input type="date" [(ngModel)]="matchForm.scheduledDate" name="scheduledDate" class="form-control">
      </div>
      <div class="mb-3">
        <label class="form-label">Status:</label>
        <select [(ngModel)]="matchForm.status" name="status" required class="form-control">
          <option value="pending">Pending</option>
          <option value="in-progress">In Progress</option>
          <option value="completed">Completed</option>
        </select>
      </div>
      <div class="mb-3" *ngIf="getMatchTeamsForEdit().length > 0">
        <label class="form-label">Winner (Optional):</label>
        <select [(ngModel)]="matchForm.winnerId" name="winnerId" class="form-control">
          <option value="">No Winner</option>
          <option *ngFor="let team of getMatchTeamsForEdit()" [value]="team.id">{{ team.name }}</option>
        </select>
      </div>
      <div class="d-flex justify-content-end gap-2">
        <button type="button" class="btn btn-secondary" (click)="editModalRef?.hide()">Cancel</button>
        <button type="submit" class="btn btn-primary">Update</button>
      </div>
    </form>
  </div>
</ng-template>

<!-- Manage Teams Modal -->
<div *ngIf="showManageTeamsModal" class="modal-overlay" (click)="closeModals()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <h3>Manage Match Teams</h3>
    <p>Select up to 2 teams for this match:</p>
    
    <div class="teams-list">
      <div *ngFor="let team of getAvailableTeamsForMatch()" 
           class="team-item" 
           [class.selected]="isTeamSelected(team.id!)"
           (click)="toggleTeamSelection(team.id!)">
        <span>{{ team.name }}</span>
        <span class="player-count">({{ team.playerIds.length }} players)</span>
      </div>
    </div>
    
    <div class="selected-teams">
      <h4>Selected Teams ({{ selectedTeams.length }}/2):</h4>
      <div *ngFor="let teamId of selectedTeams" class="selected-team">
        {{ getTeamNameById(teamId) }}
      </div>
    </div>
    
    <div class="modal-actions">
      <button type="button" class="btn btn-secondary" (click)="closeModals()">Cancel</button>
      <button type="button" class="btn btn-primary" (click)="saveMatchTeams()">Save Teams</button>
    </div>
  </div>
</div>